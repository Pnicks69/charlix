<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Work Biodata</title>
    <link rel="stylesheet" href="styles.css">
    <style>
      body {
        background: #e6ecf5;
        display: block !important;
        align-items: initial !important;
        justify-content: initial !important;
      }
      .biodata-container {
        background: #fff;
        max-width: 900px;
        margin: 2.5rem auto;
        border-radius: 16px;
        box-shadow: 0 6px 32px rgba(60, 90, 130, 0.13);
        padding: 2.5rem 2rem 2rem 2rem;
        font-family: 'Segoe UI', Arial, sans-serif;
      }
      .biodata-title {
        text-align: center;
        font-size: 2.2rem;
        font-weight: 700;
        color: #0a3d62;
        margin-bottom: 2.2rem;
      }
      .biodata-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 2.2rem 0 1.1rem 0;
        color: #222;
      }
      .biodata-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
      }
      .biodata-table th, .biodata-table td {
        border: 1px solid #c3d0e6;
        padding: 0.7rem 1rem;
        text-align: left;
        font-size: 1.05rem;
      }
      .biodata-table th {
        background: #f7faff;
        color: #3a5e9a;
        font-weight: 600;
        width: 220px;
      }
      .biodata-table td {
        color: #2d3a4a;
      }
      .biodata-list {
        margin: 0 0 1.5rem 1.5rem;
        padding: 0;
        color: #2d3a4a;
      }
      .biodata-subtable th, .biodata-subtable td {
        font-size: 1rem;
        padding: 0.5rem 0.7rem;
      }
      .biodata-subtable th {
        width: 160px;
      }
      .biodata-section {
        margin-bottom: 2rem;
      }
      .biodata-table input, .biodata-table textarea, .biodata-table select {
        width: 100%;
        padding: 0.4rem 0.7rem;
        border: 1px solid #c3d0e6;
        border-radius: 5px;
        font-size: 1rem;
        background: #f7faff;
        color: #2d3a4a;
        resize: vertical;
      }
      .biodata-table textarea {
        min-height: 2.2rem;
      }
      .biodata-list input {
        width: 80%;
        margin-bottom: 0.5rem;
      }
      .biodata-list .remove-skill {
        background: #e17055;
        color: #fff;
        border: none;
        border-radius: 4px;
        margin-left: 0.5rem;
        cursor: pointer;
        font-size: 0.95rem;
        padding: 0.1rem 0.6rem;
      }
      .biodata-list .remove-skill:hover {
        background: #d63031;
      }
      .add-btn {
        background: #5b8bd8;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.4rem 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        transition: background 0.2s;
      }
      .add-btn:hover {
        background: #3a5e9a;
      }
      .save-btn {
        background: #0984e3;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.7rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        margin: 2rem auto 0 auto;
        display: block;
        transition: background 0.2s;
      }
      .save-btn:hover {
        background: #3a5e9a;
      }
      .back-btn {
        background: #6c757d;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 1.5rem;
        transition: background 0.2s;
      }
      .back-btn:hover {
        background: #5a6268;
      }
      @media print {
        body {
          background: #fff;
        }
        .biodata-container {
          box-shadow: none;
          border-radius: 0;
        }
        .save-btn, .add-btn, .remove-skill {
          display: none !important;
        }
      }
      .danger-zone {
        margin-top: 2.5rem;
        padding: 2.7rem 2.2rem 2.2rem 2.2rem;
        border: 2px solid #e74c3c;
        background: #fff6f6;
        border-radius: 16px;
        box-shadow: 0 2px 16px rgba(231,76,60,0.09);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        font-size: 1.08rem;
      }
      .danger-zone .dz-title {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        font-weight: 700;
        color: #e74c3c;
        font-size: 1.18rem;
        margin-bottom: 0.3rem;
      }
      .danger-zone .dz-desc {
        color: #b03a2e;
        font-size: 0.98rem;
        margin-bottom: 1.2rem;
      }
      .danger-zone label {
        color: #c0392b;
        font-weight: 600;
        margin-bottom: 0.2rem;
        display: block;
      }
      .danger-zone input[type="email"],
      .danger-zone input[type="password"] {
        width: 100%;
        max-width: 100%;
        padding: 0.5rem 0.7rem;
        border: 1.5px solid #e0b4b4;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        background: #fff;
        transition: border 0.2s;
      }
      .danger-zone input[type="email"]:focus,
      .danger-zone input[type="password"]:focus {
        border: 1.5px solid #e74c3c;
        outline: none;
      }
      .danger-zone button {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 0.2rem;
        margin-bottom: 0.2rem;
        transition: background 0.2s;
      }
      .danger-zone button:hover {
        background: #c0392b;
      }
      .danger-zone .delete-btn {
        background: #fff;
        color: #e74c3c;
        border: 2px solid #e74c3c;
        font-weight: 700;
        margin-top: 0.7rem;
      }
      .danger-zone .delete-btn:hover {
        background: #e74c3c;
        color: #fff;
      }
      .danger-zone .dz-status {
        font-size: 0.97rem;
        margin-top: 0.2rem;
        min-height: 1.2em;
      }
      @media (max-width: 600px) {
        .danger-zone { padding: 1.2rem 0.5rem; }
      }
    </style>
</head>
<body>
  <!-- Side Panel -->
  <div class="nav-bar" id="navBar">
    <div class="nav-links">
      <a href="dashboard.html" class="nav-link">üìã Dashboard</a>
      <a href="edit_profile.html" class="nav-link active">‚úèÔ∏è Edit PDS</a>
      <a href="#" class="nav-link" id="printPdsBtn">üñ®Ô∏è Print PDS</a>
      <a href="#" class="nav-link" id="logoutBtn">üö™ Logout</a>
    </div>
  </div>
  
  <!-- Burger Menu Button -->
  <button class="burger-btn" id="burgerBtn">‚ò∞</button>
  
  <form class="pds-container">
    <div class="pds-main-title">PERSONAL DATA SHEET</div>
    <div class="pds-profile-section">
      <div class="pds-profile-photo-container">
        <img id="profilePhotoPreview" class="pds-profile-photo" src="" alt="Profile Photo" style="display: none;">
        <div id="profilePhotoPlaceholder" class="pds-photo-placeholder">
          <span>üì∑</span>
          <span>No Photo</span>
        </div>
      </div>
      <div class="pds-profile-info">
        <label for="profilePhotoInput" style="font-weight:600;color:#3a5e9a;">Upload Profile Photo</label><br>
        <input type="file" id="profilePhotoInput" accept="image/*" style="margin-top:0.5rem;">
        <button type="button" id="uploadProfilePhotoBtn" style="margin-left:0.5rem;">Upload</button>

        <div id="profilePhotoStatus" style="font-size:0.98rem;color:#5c6b82;margin-top:0.3rem;"></div>
      </div>
    </div>
    <!-- I. PERSONAL INFORMATION -->
    <div class="pds-section">
      <div class="pds-section-title">I. PERSONAL INFORMATION</div>
      <div class="pds-field-group">
        <div class="pds-field-row">
          <div class="pds-field-label">2. SURNAME, FIRST NAME, MIDDLE NAME</div>
          <div class="pds-name-fields">
            <input class="pds-name-box" name="surname" placeholder="Surname" required />
            <input class="pds-name-box" name="firstName" placeholder="First Name" required />
            <input class="pds-name-box" name="middleName" placeholder="Middle Name" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">3. NAME EXTENSION (e.g. Jr., Sr.)</div>
          <input class="pds-name-extension" name="nameExtension" placeholder="e.g. Jr., Sr." />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">4. DATE OF BIRTH (mm/dd/yyyy)</div>
          <input class="pds-date-field" name="dob" type="date" required />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">5. PLACE OF BIRTH</div>
          <input class="pds-text-field" name="birthPlace" placeholder="Enter your place of birth" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">6. SEX</div>
          <div class="pds-radio-group">
            <label class="pds-radio">
              <input type="radio" name="gender" value="Male" />
              <span class="pds-radio-text">Male</span>
            </label>
            <label class="pds-radio">
              <input type="radio" name="gender" value="Female" />
              <span class="pds-radio-text">Female</span>
            </label>
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">7. CIVIL STATUS</div>
          <div class="pds-checkbox-group">
            <label class="pds-checkbox">
              <input type="radio" name="civilStatus" value="Single" />
              <span class="pds-checkbox-text">Single</span>
            </label>
            <label class="pds-checkbox">
              <input type="radio" name="civilStatus" value="Married" />
              <span class="pds-checkbox-text">Married</span>
            </label>
            <label class="pds-checkbox">
              <input type="radio" name="civilStatus" value="Widowed" />
              <span class="pds-checkbox-text">Widowed</span>
            </label>
            <label class="pds-checkbox">
              <input type="radio" name="civilStatus" value="Separated" />
              <span class="pds-checkbox-text">Separated</span>
            </label>
            <label class="pds-checkbox">
              <input type="radio" name="civilStatus" value="Annulled" />
              <span class="pds-checkbox-text">Annulled</span>
            </label>
            <label class="pds-checkbox">
              <input type="radio" name="civilStatus" value="Others" />
              <span class="pds-checkbox-text">Others, specify</span>
            </label>
            <input class="pds-others-field" name="civilStatusOthers" placeholder="If Others, specify" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">8. CITIZENSHIP</div>
          <input class="pds-text-field" name="nationality" placeholder="Enter your citizenship" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">RELIGION</div>
          <input class="pds-text-field" name="religion" placeholder="Enter your religion" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">9. HEIGHT (m)</div>
          <input class="pds-text-field" name="height" placeholder="e.g. 1.75" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">10. WEIGHT (kg)</div>
          <input class="pds-text-field" name="weight" placeholder="e.g. 70" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">11. BLOOD TYPE</div>
          <input class="pds-text-field" name="bloodType" placeholder="e.g. A+, B-, O+" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">12. GSIS ID NO.</div>
          <input class="pds-text-field" name="gsisId" placeholder="Enter GSIS ID" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">13. PAG-IBIG ID NO.</div>
          <input class="pds-text-field" name="pagibigId" placeholder="Enter PAG-IBIG ID" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">14. PHILHEALTH NO.</div>
          <input class="pds-text-field" name="philhealthNo" placeholder="Enter PHILHEALTH No." />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">15. SSS NO.</div>
          <input class="pds-text-field" name="sssNo" placeholder="Enter SSS No." />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">16. RESIDENTIAL ADDRESS</div>
          <textarea class="pds-textarea-field" name="address" placeholder="Enter your residential address"></textarea>
          <div class="pds-zip-row">
            <span class="pds-zip-label">ZIP CODE</span>
            <input class="pds-zip-field" name="residentialZip" placeholder="Enter ZIP code" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">17. TELEPHONE NO.</div>
          <input class="pds-text-field" name="contact" placeholder="Enter residential phone" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">18. PERMANENT ADDRESS</div>
          <textarea class="pds-textarea-field" name="permanentAddress" placeholder="Enter your permanent address"></textarea>
          <div class="pds-zip-row">
            <span class="pds-zip-label">ZIP CODE</span>
            <input class="pds-zip-field" name="permanentZip" placeholder="Enter ZIP code" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">19. TELEPHONE NO.</div>
          <input class="pds-text-field" name="permanentPhone" placeholder="Enter permanent phone" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">20. E-MAIL ADDRESS (if any)</div>
          <input class="pds-text-field" name="email" type="email" placeholder="Enter your email address" required />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">21. CELLPHONE NO. (if any)</div>
          <input class="pds-text-field" name="cellphone" placeholder="Enter your cellphone number" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">22. AGENCY EMPLOYEE NO.</div>
          <input class="pds-text-field" name="agencyEmployeeNo" placeholder="Enter agency employee number" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">23. TIN</div>
          <input class="pds-text-field" name="tin" placeholder="Enter TIN" />
        </div>
      </div>
    </div>
    <!-- II. FAMILY BACKGROUND -->
    <div class="pds-section">
      <div class="pds-section-title">II. FAMILY BACKGROUND</div>
      <div class="pds-field-group">
        <div class="pds-field-row">
          <div class="pds-field-label">24. SPOUSE'S SURNAME, FIRST NAME, MIDDLE NAME</div>
          <div class="pds-name-fields">
            <input class="pds-name-box" name="spouseSurname" placeholder="Spouse Surname" />
            <input class="pds-name-box" name="spouseFirstName" placeholder="Spouse First Name" />
            <input class="pds-name-box" name="spouseMiddleName" placeholder="Spouse Middle Name" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">OCCUPATION</div>
          <input class="pds-text-field" name="spouseOccupation" placeholder="Enter spouse's occupation" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">EMPLOYER/BUS. NAME</div>
          <input class="pds-text-field" name="spouseEmployer" placeholder="Enter employer/business name" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">BUSINESS ADDRESS</div>
          <input class="pds-text-field" name="spouseBusinessAddress" placeholder="Enter business address" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">TELEPHONE NO.</div>
          <input class="pds-text-field" name="spousePhone" placeholder="Enter spouse's phone" />
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">FATHER'S SURNAME, FIRST NAME, MIDDLE NAME</div>
          <div class="pds-name-fields">
            <input class="pds-name-box" name="fatherSurname" placeholder="Father Surname" />
            <input class="pds-name-box" name="fatherFirstName" placeholder="Father First Name" />
            <input class="pds-name-box" name="fatherMiddleName" placeholder="Father Middle Name" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">MOTHER'S SURNAME, FIRST NAME, MIDDLE NAME</div>
          <div class="pds-name-fields">
            <input class="pds-name-box" name="motherSurname" placeholder="Mother Surname" />
            <input class="pds-name-box" name="motherFirstName" placeholder="Mother First Name" />
            <input class="pds-name-box" name="motherMiddleName" placeholder="Mother Middle Name" />
          </div>
        </div>
        <div class="pds-field-row">
          <div class="pds-field-label">CHILDREN</div>
          <div>
            <ul class="biodata-list" id="childrenList">
              <li><input type="text" name="childName[]" placeholder="Child's full name"><input type="date" name="childBirthDate[]" placeholder="Birth date"><button type="button" class="remove-skill">Remove</button></li>
            </ul>
            <button type="button" class="add-btn" id="addChildBtn">Add Child</button>
          </div>
        </div>
      </div>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">3. Career Objective</div>
      <textarea name="objective" placeholder="Describe your career goals and objectives" style="width:100%;min-height:3.5rem;"></textarea>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">4. Educational Background</div>
      <table class="biodata-table biodata-subtable">
        <tr><th>Level</th><th>School Name</th><th>Year Graduated</th><th>Honors/Awards</th></tr>
        <tr><td>Elementary</td><td><input type="text" name="elemSchool" placeholder="School name"></td><td><input type="text" name="elemYear" placeholder="Year"></td><td><input type="text" name="elemHonors" placeholder="Honors/Awards"></td></tr>
        <tr><td>Secondary</td><td><input type="text" name="secSchool" placeholder="School name"></td><td><input type="text" name="secYear" placeholder="Year"></td><td><input type="text" name="secHonors" placeholder="Honors/Awards"></td></tr>
        <tr><td>Tertiary</td><td><input type="text" name="terSchool" placeholder="School name"></td><td><input type="text" name="terYear" placeholder="Year"></td><td><input type="text" name="terHonors" placeholder="Honors/Awards"></td></tr>
      </table>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">5. Skills and Qualifications</div>
      <ul class="biodata-list" id="skillsList">
        <li><input type="text" name="skills[]" placeholder="Enter your skill"><button type="button" class="remove-skill">Remove</button></li>
      </ul>
      <button type="button" class="add-btn" id="addSkillBtn">Add Skill</button>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">6. Work Experience</div>
      <table class="biodata-table biodata-subtable" id="workExpTable">
        <tr><th>Position</th><th>Company Name</th><th>Inclusive Dates</th><th>Responsibilities/Highlights</th><th></th></tr>
        <tr>
          <td><input type="text" name="position[]" placeholder="Job title"></td>
          <td><input type="text" name="company[]" placeholder="Company name"></td>
          <td><input type="text" name="dates[]" placeholder="e.g., 2020-2023"></td>
          <td><input type="text" name="highlights[]" placeholder="Key responsibilities"></td>
          <td><button type="button" class="remove-skill">Remove</button></td>
        </tr>
      </table>
      <button type="button" class="add-btn" id="addWorkBtn">Add Work Experience</button>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">7. Strengths</div>
      <ul class="biodata-list" id="strengthsList">
        <li><input type="text" name="strengths[]" placeholder="Enter your strength"><button type="button" class="remove-skill">Remove</button></li>
      </ul>
      <button type="button" class="add-btn" id="addStrengthBtn">Add Strength</button>
      <div class="biodata-section-title" style="margin-top:2rem;">8. Weaknesses</div>
      <ul class="biodata-list" id="weaknessesList">
        <li><input type="text" name="weaknesses[]" placeholder="Enter your weakness"><button type="button" class="remove-skill">Remove</button></li>
      </ul>
          <button type="button" class="add-btn" id="addWeaknessBtn">Add Weakness</button>
  </div>

  <button type="button" class="save-btn" id="saveMainFormBtn">Save Changes</button>
  </form>
  <div class="danger-zone">
    <div class="dz-title"><span style="font-size:1.5rem;">&#9888;&#65039;</span> Danger Zone</div>
    <div class="dz-desc">Sensitive actions below. Please proceed with caution.</div>
    <div style="margin-bottom:1.2rem;">
      <label for="dangerEmail">Change Email</label>
      <input type="email" id="dangerEmail">
      <button type="button" id="changeEmailBtn">Change Email</button>
      <div id="dangerEmailStatus" class="dz-status"></div>
    </div>
    <div style="margin-bottom:1.2rem;">
      <label for="dangerOldPassword">Change Password</label>
      <input type="password" id="dangerOldPassword" placeholder="Old password">
      <input type="password" id="dangerNewPassword" placeholder="New password">
      <input type="password" id="dangerRepeatPassword" placeholder="Repeat new password">
      <button type="button" id="changePasswordBtn">Change Password</button>
      <div id="dangerPasswordStatus" class="dz-status"></div>
    </div>
    <div>
      <button type="button" id="deleteAccountBtn" class="delete-btn">Delete Account</button>
      <div id="dangerDeleteStatus" class="dz-status"></div>
    </div>
  </div>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, updateEmail, updatePassword, deleteUser, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBSw3t0Picp9CrK0CsB_FXeSC7wHuZQbMw",
        authDomain: "carlix-7fbcb.firebaseapp.com",
        projectId: "carlix-7fbcb",
        storageBucket: "carlix-7fbcb.firebasestorage.app",
        messagingSenderId: "679556059179",
        appId: "1:679556059179:web:1893b4b1063e87dd789a6e",
        measurementId: "G-TMKR8YLFR4"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const form = document.querySelector('.pds-container');
      const loadingMsg = document.createElement('div');
      loadingMsg.textContent = 'Loading...';
      loadingMsg.style.textAlign = 'center';
      loadingMsg.style.margin = '1.5rem 0';
      form.insertBefore(loadingMsg, form.firstChild);

      let currentUid = null;
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUid = user.uid;
          // Fetch and populate user data
          const userDoc = await getDoc(doc(db, 'users', currentUid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            // Set all form fields (dashboard-style)
            if (form.surname) form.surname.value = data.surname || '';
            if (form.firstName) form.firstName.value = data.firstName || '';
            if (form.middleName) form.middleName.value = data.middleName || '';
            if (form.nameExtension) form.nameExtension.value = data.nameExtension || '';
            if (form.dob) form.dob.value = data.dateOfBirth || data.birthdate || data.dob || '';
            // Calculate age from date of birth if available
            if (form.dob && form.age) {
              if (form.dob.value) {
                const today = new Date();
                const birth = new Date(form.dob.value);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                  age--;
                }
                form.age.value = age > 0 ? age : (data.age || '');
              } else {
                form.age.value = data.age || '';
              }
            }
            // Gender radio
            if (data.gender) {
              const genderRadio = form.querySelectorAll('input[name="gender"]');
              genderRadio.forEach(r => { r.checked = (r.value === data.gender); });
            }
            // Civil Status checkboxes
            if (data.civilStatus) {
              const civilStatusCheckboxes = form.querySelectorAll('input[name="civilStatus"]');
              civilStatusCheckboxes.forEach(cb => { cb.checked = (cb.value === data.civilStatus); });
              if (data.civilStatus === 'Others' && form.civilStatusOthers) {
                form.civilStatusOthers.value = data.civilStatusOthers || '';
              }
            }
            if (form.nationality) form.nationality.value = data.nationality || '';
            if (form.height) form.height.value = data.height || '';
            if (form.weight) form.weight.value = data.weight || '';
            if (form.bloodType) form.bloodType.value = data.bloodType || '';
            if (form.gsisId) form.gsisId.value = data.gsisId || '';
            if (form.pagibigId) form.pagibigId.value = data.pagibigId || '';
            if (form.philhealthNo) form.philhealthNo.value = data.philhealthNo || '';
            if (form.sssNo) form.sssNo.value = data.sssNo || '';
            if (form.address) form.address.value = data.address || '';
            if (form.residentialZip) form.residentialZip.value = data.residentialZip || '';
            if (form.contact) form.contact.value = data.contactNumber || '';
            if (form.permanentAddress) form.permanentAddress.value = data.permanentAddress || '';
            if (form.permanentZip) form.permanentZip.value = data.permanentZip || '';
            if (form.permanentPhone) form.permanentPhone.value = data.permanentPhone || '';
            if (form.email) form.email.value = data.email || user.email || '';
            if (form.cellphone) form.cellphone.value = data.cellphone || '';
            if (form.agencyEmployeeNo) form.agencyEmployeeNo.value = data.agencyEmployeeNo || '';
            if (form.tin) form.tin.value = data.tin || '';
            if (form.religion) form.religion.value = data.religion || '';
            // Family background
            if (form.spouseSurname) form.spouseSurname.value = data.spouseSurname || '';
            if (form.spouseFirstName) form.spouseFirstName.value = data.spouseFirstName || '';
            if (form.spouseMiddleName) form.spouseMiddleName.value = data.spouseMiddleName || '';
            if (form.spouseOccupation) form.spouseOccupation.value = data.spouseOccupation || '';
            if (form.spouseEmployer) form.spouseEmployer.value = data.spouseEmployer || '';
            if (form.spouseBusinessAddress) form.spouseBusinessAddress.value = data.spouseBusinessAddress || '';
            if (form.spousePhone) form.spousePhone.value = data.spousePhone || '';
            if (form.fatherSurname) form.fatherSurname.value = data.fatherSurname || '';
            if (form.fatherFirstName) form.fatherFirstName.value = data.fatherFirstName || '';
            if (form.fatherMiddleName) form.fatherMiddleName.value = data.fatherMiddleName || '';
            if (form.motherSurname) form.motherSurname.value = data.motherSurname || '';
            if (form.motherFirstName) form.motherFirstName.value = data.motherFirstName || '';
            if (form.motherMiddleName) form.motherMiddleName.value = data.motherMiddleName || '';
            // Children
            const childrenList = document.getElementById('childrenList');
            if (childrenList && data.children && Array.isArray(data.children)) {
              childrenList.innerHTML = '';
              data.children.forEach(child => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="text" name="childName[]" value="${child.name || ''}" placeholder="Child's full name"><input type="date" name="childBirthDate[]" value="${child.birthDate || ''}" placeholder="Birth date"><button type="button" class="remove-skill">Remove</button>`;
                childrenList.appendChild(li);
              });
            }
            // Objective
            if (form.objective) form.objective.value = data.objective || '';
            // Education
            if (form.elemSchool) form.elemSchool.value = (data.education?.elementary?.school) || data.elemSchool || '';
            if (form.elemYear) form.elemYear.value = (data.education?.elementary?.year) || data.elemYear || '';
            if (form.elemHonors) form.elemHonors.value = (data.education?.elementary?.honors) || data.elemHonors || '';
            if (form.secSchool) form.secSchool.value = (data.education?.secondary?.school) || data.secSchool || '';
            if (form.secYear) form.secYear.value = (data.education?.secondary?.year) || data.secYear || '';
            if (form.secHonors) form.secHonors.value = (data.education?.secondary?.honors) || data.secHonors || '';
            if (form.terSchool) form.terSchool.value = (data.education?.tertiary?.school) || data.terSchool || '';
            if (form.terYear) form.terYear.value = (data.education?.tertiary?.year) || data.terYear || '';
            if (form.terHonors) form.terHonors.value = (data.education?.tertiary?.honors) || data.terHonors || '';
            // Skills
            const skillsList = document.getElementById('skillsList');
            if (skillsList) {
              skillsList.innerHTML = '';
              (Array.isArray(data.skills) ? data.skills : ['']).forEach(skill => {
                const li = document.createElement('li');
                const sanitizedSkill = skill.replace(/[<>]/g, '');
                li.innerHTML = `<input type="text" name="skills[]" value="${sanitizedSkill}" placeholder="Enter your skill"><button type="button" class="remove-skill">Remove</button>`;
                skillsList.appendChild(li);
              });
            }
            // Strengths
            const strengthsList = document.getElementById('strengthsList');
            if (strengthsList) {
              strengthsList.innerHTML = '';
              (Array.isArray(data.strengths) ? data.strengths : ['']).forEach(strength => {
                const li = document.createElement('li');
                const sanitizedStrength = strength.replace(/[<>]/g, '');
                li.innerHTML = `<input type="text" name="strengths[]" value="${sanitizedStrength}" placeholder="Enter your strength"><button type="button" class="remove-skill">Remove</button>`;
                strengthsList.appendChild(li);
              });
            }
            // Weaknesses
            const weaknessesList = document.getElementById('weaknessesList');
            if (weaknessesList) {
              weaknessesList.innerHTML = '';
              (Array.isArray(data.weaknesses) ? data.weaknesses : ['']).forEach(weakness => {
                const li = document.createElement('li');
                const sanitizedWeakness = weakness.replace(/[<>]/g, '');
                li.innerHTML = `<input type="text" name="weaknesses[]" value="${sanitizedWeakness}" placeholder="Enter your weakness"><button type="button" class="remove-skill">Remove</button>`;
                weaknessesList.appendChild(li);
              });
            }
            // Work Experience
            const workExpTable = document.getElementById('workExpTable');
            if (workExpTable) {
              workExpTable.querySelectorAll('tr:not(:first-child)').forEach(tr => tr.remove());
              (data.workExperience || [{position:'',company:'',dates:'',highlights:''}]).forEach(exp => {
                const row = document.createElement('tr');
                const sanitizedPosition = (exp.position || '').replace(/[<>]/g, '');
                const sanitizedCompany = (exp.company || '').replace(/[<>]/g, '');
                const sanitizedDates = (exp.dates || '').replace(/[<>]/g, '');
                const sanitizedHighlights = (exp.highlights || '').replace(/[<>]/g, '');
                row.innerHTML = `<td><input type="text" name="position[]" value="${sanitizedPosition}" placeholder="Job title"></td><td><input type="text" name="company[]" value="${sanitizedCompany}" placeholder="Company name"></td><td><input type="text" name="dates[]" value="${sanitizedDates}" placeholder="e.g., 2020-2023"></td><td><input type="text" name="highlights[]" value="${sanitizedHighlights}" placeholder="Key responsibilities"></td><td><button type="button" class="remove-skill">Remove</button></td>`;
                workExpTable.appendChild(row);
              });
            }
          }
        } else {
          window.location.href = 'index.html';
        }
      });

      // Manual save function
      async function saveToFirestore() {
        if (!currentUid) return;
        
        try {
          // Gather all data
          const education = {
            elementary: { school: form.elemSchool.value, year: form.elemYear.value, honors: form.elemHonors.value },
            secondary: { school: form.secSchool.value, year: form.secYear.value, honors: form.secHonors.value },
            tertiary: { school: form.terSchool.value, year: form.terYear.value, honors: form.terHonors.value }
          };
          const skills = Array.from(form.querySelectorAll('input[name="skills[]"]')).map(i => i.value).filter(Boolean);
          const strengths = Array.from(form.querySelectorAll('input[name="strengths[]"]')).map(i => i.value).filter(Boolean);
          const weaknesses = Array.from(form.querySelectorAll('input[name="weaknesses[]"]')).map(i => i.value).filter(Boolean);
          const workExperience = Array.from(document.querySelectorAll('#workExpTable tr:not(:first-child)')).map(tr => {
            const tds = tr.querySelectorAll('td');
            return {
              position: tds[0].querySelector('input').value,
              company: tds[1].querySelector('input').value,
              dates: tds[2].querySelector('input').value,
              highlights: tds[3].querySelector('input').value
            };
          }).filter(exp => exp.position || exp.company || exp.dates || exp.highlights);
          
          // Gather children data
          const children = Array.from(document.querySelectorAll('#childrenList li')).map(li => {
            const nameInput = li.querySelector('input[name="childName[]"]');
            const dateInput = li.querySelector('input[name="childBirthDate[]"]');
            return {
              name: nameInput ? nameInput.value : '',
              birthDate: dateInput ? dateInput.value : ''
            };
          }).filter(child => child.name || child.birthDate);
          
          // Save to Firestore
          await setDoc(doc(db, 'users', currentUid), {
            surname: form.surname ? form.surname.value : '',
            firstName: form.firstName ? form.firstName.value : '',
            middleName: form.middleName ? form.middleName.value : '',
            nameExtension: form.nameExtension ? form.nameExtension.value : '',
            dateOfBirth: form.dob ? form.dob.value : '',
            birthPlace: form.birthPlace ? form.birthPlace.value : '',
            age: form.age ? form.age.value : '',
            gender: form.gender ? form.gender.value : '',
            civilStatus: (() => {
              const checked = Array.from(form.querySelectorAll('input[name="civilStatus"]')).find(cb => cb.checked);
              return checked ? checked.value : '';
            })(),
            civilStatusOthers: form.civilStatusOthers ? form.civilStatusOthers.value : '',
            nationality: form.nationality ? form.nationality.value : '',
            height: form.height ? form.height.value : '',
            weight: form.weight ? form.weight.value : '',
            bloodType: form.bloodType ? form.bloodType.value : '',
            gsisId: form.gsisId ? form.gsisId.value : '',
            pagibigId: form.pagibigId ? form.pagibigId.value : '',
            philhealthNo: form.philhealthNo ? form.philhealthNo.value : '',
            sssNo: form.sssNo ? form.sssNo.value : '',
            address: form.address ? form.address.value : '',
            residentialZip: form.residentialZip ? form.residentialZip.value : '',
            contactNumber: form.contact ? form.contact.value : '',
            permanentAddress: form.permanentAddress ? form.permanentAddress.value : '',
            permanentZip: form.permanentZip ? form.permanentZip.value : '',
            permanentPhone: form.permanentPhone ? form.permanentPhone.value : '',
            email: form.email ? form.email.value : '',
            cellphone: form.cellphone ? form.cellphone.value : '',
            agencyEmployeeNo: form.agencyEmployeeNo ? form.agencyEmployeeNo.value : '',
            tin: form.tin ? form.tin.value : '',
            religion: form.religion ? form.religion.value : '',
            spouseSurname: form.spouseSurname ? form.spouseSurname.value : '',
            spouseFirstName: form.spouseFirstName ? form.spouseFirstName.value : '',
            spouseMiddleName: form.spouseMiddleName ? form.spouseMiddleName.value : '',
            spouseOccupation: form.spouseOccupation ? form.spouseOccupation.value : '',
            spouseEmployer: form.spouseEmployer ? form.spouseEmployer.value : '',
            spouseBusinessAddress: form.spouseBusinessAddress ? form.spouseBusinessAddress.value : '',
            spousePhone: form.spousePhone ? form.spousePhone.value : '',
            fatherSurname: form.fatherSurname ? form.fatherSurname.value : '',
            fatherFirstName: form.fatherFirstName ? form.fatherFirstName.value : '',
            fatherMiddleName: form.fatherMiddleName ? form.fatherMiddleName.value : '',
            motherSurname: form.motherSurname ? form.motherSurname.value : '',
            motherFirstName: form.motherFirstName ? form.motherFirstName.value : '',
            motherMiddleName: form.motherMiddleName ? form.motherMiddleName.value : '',
            children: children,
            objective: form.objective ? form.objective.value : '',
            education,
            skills,
            strengths,
            weaknesses,
            workExperience
          }, { merge: true });
          
          // Show subtle save indicator
          showSaveIndicator('Saved successfully');
        } catch (err) {
          console.error('Save failed:', err);
          showSaveIndicator('Save failed', 'error');
        }
      }

      // Save indicator function
      function showSaveIndicator(message, type = 'success') {
        // Remove existing indicator
        const existingIndicator = document.querySelector('.save-indicator');
        if (existingIndicator) {
          existingIndicator.remove();
        }
        
        // Create new indicator
        const indicator = document.createElement('div');
        indicator.className = 'save-indicator';
        indicator.textContent = message;
        indicator.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
          color: white;
          padding: 8px 16px;
          border-radius: 4px;
          font-size: 14px;
          z-index: 1000;
          opacity: 0;
          transition: opacity 0.3s;
        `;
        
        document.body.appendChild(indicator);
        
        // Fade in
        setTimeout(() => {
          indicator.style.opacity = '1';
        }, 10);
        
        // Fade out and remove after 2 seconds
        setTimeout(() => {
          indicator.style.opacity = '0';
          setTimeout(() => {
            if (indicator.parentNode) {
              indicator.parentNode.removeChild(indicator);
            }
          }, 300);
        }, 2000);
      }

      // Danger Zone logic
      const dangerEmail = document.getElementById('dangerEmail');
      const changeEmailBtn = document.getElementById('changeEmailBtn');
      const dangerEmailStatus = document.getElementById('dangerEmailStatus');
      const dangerOldPassword = document.getElementById('dangerOldPassword');
      const dangerNewPassword = document.getElementById('dangerNewPassword');
      const dangerRepeatPassword = document.getElementById('dangerRepeatPassword');
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const dangerPasswordStatus = document.getElementById('dangerPasswordStatus');
      const deleteAccountBtn = document.getElementById('deleteAccountBtn');
      const dangerDeleteStatus = document.getElementById('dangerDeleteStatus');

      // Only add event listeners if elements exist
      if (changeEmailBtn && dangerEmail && dangerEmailStatus) {
        // Change Email
        changeEmailBtn.addEventListener('click', async () => {
          dangerEmailStatus.textContent = '';
          if (!dangerEmail.value || !currentUid) {
            dangerEmailStatus.textContent = 'Please enter a valid email.';
            dangerEmailStatus.style.color = 'red';
            return;
          }
          try {
            const user = auth.currentUser;
            await updateEmail(user, dangerEmail.value);
            await setDoc(doc(db, 'users', currentUid), { email: dangerEmail.value }, { merge: true });
            dangerEmailStatus.textContent = 'Email updated successfully!';
            dangerEmailStatus.style.color = 'green';
          } catch (err) {
            if (err.code === 'auth/requires-recent-login') {
              dangerEmailStatus.textContent = 'Please re-authenticate to change your email.';
            } else {
              dangerEmailStatus.textContent = err.message || 'Failed to update email.';
            }
            dangerEmailStatus.style.color = 'red';
          }
        });
      }

      // Change Password
      if (changePasswordBtn && dangerOldPassword && dangerNewPassword && dangerRepeatPassword && dangerPasswordStatus) {
        changePasswordBtn.addEventListener('click', async () => {
          dangerPasswordStatus.textContent = '';
          if (!dangerOldPassword.value || !dangerNewPassword.value || !dangerRepeatPassword.value || !currentUid) {
            dangerPasswordStatus.textContent = 'Please fill in all password fields.';
            dangerPasswordStatus.style.color = 'red';
            return;
          }
          if (dangerNewPassword.value !== dangerRepeatPassword.value) {
            dangerPasswordStatus.textContent = 'New passwords do not match.';
            dangerPasswordStatus.style.color = 'red';
            return;
          }
          try {
            const user = auth.currentUser;
            // Re-authenticate with old password
            const credential = EmailAuthProvider.credential(user.email, dangerOldPassword.value);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, dangerNewPassword.value);
            dangerPasswordStatus.textContent = 'Password updated successfully!';
            dangerPasswordStatus.style.color = 'green';
            dangerOldPassword.value = '';
            dangerNewPassword.value = '';
            dangerRepeatPassword.value = '';
          } catch (err) {
            if (err.code === 'auth/wrong-password') {
              dangerPasswordStatus.textContent = 'Old password is incorrect.';
            } else if (err.code === 'auth/requires-recent-login') {
              dangerPasswordStatus.textContent = 'Please re-authenticate to change your password.';
            } else {
              dangerPasswordStatus.textContent = err.message || 'Failed to update password.';
            }
            dangerPasswordStatus.style.color = 'red';
          }
        });
      }

      // Delete Account
      if (deleteAccountBtn && dangerDeleteStatus) {
        deleteAccountBtn.addEventListener('click', async () => {
          dangerDeleteStatus.textContent = '';
          if (!currentUid) return;
          if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
          try {
            const user = auth.currentUser;
            await deleteUser(user);
            await setDoc(doc(db, 'users', currentUid), {}, { merge: false }); // Optionally delete user data
            dangerDeleteStatus.textContent = 'Account deleted successfully.';
            dangerDeleteStatus.style.color = 'green';
          } catch (err) {
            if (err.code === 'auth/requires-recent-login') {
              dangerDeleteStatus.textContent = 'Please re-authenticate to delete your account.';
            } else {
              dangerDeleteStatus.textContent = err.message || 'Failed to delete account.';
            }
            dangerDeleteStatus.style.color = 'red';
          }
        });
      }

      // --- Restore Back Button and Profile Photo Upload Functionality ---
      document.addEventListener('DOMContentLoaded', () => {
        // Back button
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            window.history.length > 1 ? window.history.back() : window.location.href = 'dashboard.html';
          });
        }

              // Add/Remove functionality for Skills, Strengths, Weaknesses, Work Experience, and Children
      const addSkillBtn = document.getElementById('addSkillBtn');
      const addStrengthBtn = document.getElementById('addStrengthBtn');
      const addWeaknessBtn = document.getElementById('addWeaknessBtn');
      const addWorkBtn = document.getElementById('addWorkBtn');
      const addChildBtn = document.getElementById('addChildBtn');

        // Add Skill
        if (addSkillBtn) {
          addSkillBtn.addEventListener('click', () => {
            const skillsList = document.getElementById('skillsList');
            const li = document.createElement('li');
            li.innerHTML = '<input type="text" name="skills[]" placeholder="Enter your skill"><button type="button" class="remove-skill">Remove</button>';
            skillsList.appendChild(li);
          });
        }

        // Add Strength
        if (addStrengthBtn) {
          addStrengthBtn.addEventListener('click', () => {
            const strengthsList = document.getElementById('strengthsList');
            const li = document.createElement('li');
            li.innerHTML = '<input type="text" name="strengths[]" placeholder="Enter your strength"><button type="button" class="remove-skill">Remove</button>';
            strengthsList.appendChild(li);
          });
        }

        // Add Weakness
        if (addWeaknessBtn) {
          addWeaknessBtn.addEventListener('click', () => {
            const weaknessesList = document.getElementById('weaknessesList');
            const li = document.createElement('li');
            li.innerHTML = '<input type="text" name="weaknesses[]" placeholder="Enter your weakness"><button type="button" class="remove-skill">Remove</button>';
            weaknessesList.appendChild(li);
          });
        }

        // Add Work Experience
        if (addWorkBtn) {
          addWorkBtn.addEventListener('click', () => {
            const workExpTable = document.getElementById('workExpTable');
            const row = document.createElement('tr');
            row.innerHTML = '<td><input type="text" name="position[]" placeholder="Job title"></td><td><input type="text" name="company[]" placeholder="Company name"></td><td><input type="text" name="dates[]" placeholder="e.g., 2020-2023"></td><td><input type="text" name="highlights[]" placeholder="Key responsibilities"></td><td><button type="button" class="remove-skill">Remove</button></td>';
            workExpTable.appendChild(row);
          });
        }
        
        // Add Child
        if (addChildBtn) {
          addChildBtn.addEventListener('click', () => {
            const childrenList = document.getElementById('childrenList');
            const li = document.createElement('li');
            li.innerHTML = '<input type="text" name="childName[]" placeholder="Child\'s full name"><input type="date" name="childBirthDate[]" placeholder="Birth date"><button type="button" class="remove-skill">Remove</button>';
            childrenList.appendChild(li);
          });
        }

        // Remove functionality (delegated event listener)
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('remove-skill')) {
            if (confirm('Are you sure you want to remove this item?')) {
              e.target.parentElement.remove();
            }
          }
        });

        // Manual save button for main form
        const saveMainFormBtn = document.getElementById('saveMainFormBtn');
        if (saveMainFormBtn) {
          saveMainFormBtn.addEventListener('click', () => {
            saveToFirestore();
          });
        }

        // Age calculation function
        function calculateAge(birthDate) {
          if (!birthDate) return '';
          const today = new Date();
          const birth = new Date(birthDate);
          let age = today.getFullYear() - birth.getFullYear();
          const monthDiff = today.getMonth() - birth.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
          }
          return age > 0 ? age : '';
        }

        // Auto-calculate age when date of birth changes
        const dobInput = form.querySelector('input[name="dob"]');
        const ageInput = form.querySelector('input[name="age"]');
        if (dobInput && ageInput) {
          dobInput.addEventListener('change', () => {
            ageInput.value = calculateAge(dobInput.value);
          });
        }
        // Profile photo upload
        const profilePhotoInput = document.getElementById('profilePhotoInput');
        const uploadProfilePhotoBtn = document.getElementById('uploadProfilePhotoBtn');
        const profilePhotoPreview = document.getElementById('profilePhotoPreview');
        const profilePhotoPlaceholder = document.getElementById('profilePhotoPlaceholder');
        const profilePhotoStatus = document.getElementById('profilePhotoStatus');
        let uploadedProfilePicUrl = '';
        // Cloudinary config and helper
        const CLOUDINARY_CLOUD_NAME = 'dzvojulwb';
        const CLOUDINARY_UNSIGNED_PRESET = 'charlix';
        async function uploadProfilePic(file) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', CLOUDINARY_UNSIGNED_PRESET);
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if (data.secure_url) {
            return data.secure_url;
          } else {
            throw new Error('Profile picture upload failed.');
          }
        }
        if (uploadProfilePhotoBtn) {
          uploadProfilePhotoBtn.addEventListener('click', async () => {
            profilePhotoStatus.textContent = '';
            if (!profilePhotoInput.files || !profilePhotoInput.files[0]) {
              profilePhotoStatus.textContent = 'Please select a photo first.';
              profilePhotoStatus.style.color = 'red';
              return;
            }
            if (!currentUid) {
              profilePhotoStatus.textContent = 'User not loaded yet.';
              profilePhotoStatus.style.color = 'red';
              return;
            }
            const file = profilePhotoInput.files[0];
            profilePhotoStatus.textContent = 'Uploading...';
            profilePhotoStatus.style.color = '#5c6b82';
            try {
              const url = await uploadProfilePic(file);
              uploadedProfilePicUrl = url;
              // Save to Firestore
              await setDoc(doc(db, 'users', currentUid), { profilePicUrl: url }, { merge: true });
              // Always show the uploaded image as the profile photo
              profilePhotoPreview.src = url;
              profilePhotoPreview.style.display = 'block';
              profilePhotoPlaceholder.style.display = 'none';
              profilePhotoStatus.textContent = 'Upload successful!';
              profilePhotoStatus.style.color = 'green';
            } catch (err) {
              profilePhotoStatus.textContent = err.message || 'Upload failed.';
              profilePhotoStatus.style.color = 'red';
            }
          });
        }
        // On page load, if a profilePicUrl exists, show it in the preview
        (async () => {
          if (currentUid) {
            const userDoc = await getDoc(doc(db, 'users', currentUid));
            if (userDoc.exists()) {
              const data = userDoc.data();
              if (data.profilePicUrl) {
                profilePhotoPreview.src = data.profilePicUrl;
                profilePhotoPreview.style.display = 'block';
                profilePhotoPlaceholder.style.display = 'none';
              }
            }
          }
        })();
        // Profile photo preview logic
        if (profilePhotoInput) {
          profilePhotoInput.addEventListener('change', function() {
            if (profilePhotoInput.files && profilePhotoInput.files[0]) {
              const reader = new FileReader();
              reader.onload = function(e) {
                profilePhotoPreview.src = e.target.result;
                profilePhotoPreview.style.display = 'block';
                profilePhotoPlaceholder.style.display = 'none';
                profilePhotoStatus.textContent = '';
              };
              reader.readAsDataURL(profilePhotoInput.files[0]);
            } else {
              profilePhotoPreview.src = '';
              profilePhotoPreview.style.display = 'none';
              profilePhotoPlaceholder.style.display = 'flex';
              profilePhotoStatus.textContent = '';
            }
          });
        }

        
        // Side Panel Functionality
        const burgerBtn = document.getElementById('burgerBtn');
        const navBar = document.getElementById('navBar');
        const printPdsBtn = document.getElementById('printPdsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Burger menu toggle
        if (burgerBtn && navBar) {
          burgerBtn.addEventListener('click', () => {
            navBar.classList.toggle('mobile-visible');
          });
        }
        
        // Print PDS functionality
        if (printPdsBtn) {
          printPdsBtn.addEventListener('click', () => {
            window.print();
          });
        }
        
        // Logout functionality
        if (logoutBtn) {
          let isLoggingOut = false; // Flag to prevent multiple logout attempts
          logoutBtn.addEventListener('click', async () => {
            if (isLoggingOut) return; // Prevent multiple clicks
            
            isLoggingOut = true;
            logoutBtn.textContent = 'Logging out...';
            logoutBtn.disabled = true;
            
            try {
              await auth.signOut();
              // Clear any stored data
              localStorage.clear();
              sessionStorage.clear();
              window.location.href = 'index.html';
            } catch (error) {
              console.error('Logout error:', error);
              // Reset button state if logout fails
              isLoggingOut = false;
              logoutBtn.textContent = 'üö™ Logout';
              logoutBtn.disabled = false;
            }
          });
        }
      });
    </script>
  </body>
</html> 