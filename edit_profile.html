<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Work Biodata</title>
    <link rel="stylesheet" href="styles.css">
    <style>
      body {
        background: #e6ecf5;
        display: block !important;
        align-items: initial !important;
        justify-content: initial !important;
      }
      .biodata-container {
        background: #fff;
        max-width: 900px;
        margin: 2.5rem auto;
        border-radius: 16px;
        box-shadow: 0 6px 32px rgba(60, 90, 130, 0.13);
        padding: 2.5rem 2rem 2rem 2rem;
        font-family: 'Segoe UI', Arial, sans-serif;
      }
      .biodata-title {
        text-align: center;
        font-size: 2.2rem;
        font-weight: 700;
        color: #0a3d62;
        margin-bottom: 2.2rem;
      }
      .biodata-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 2.2rem 0 1.1rem 0;
        color: #222;
      }
      .biodata-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
      }
      .biodata-table th, .biodata-table td {
        border: 1px solid #c3d0e6;
        padding: 0.7rem 1rem;
        text-align: left;
        font-size: 1.05rem;
      }
      .biodata-table th {
        background: #f7faff;
        color: #3a5e9a;
        font-weight: 600;
        width: 220px;
      }
      .biodata-table td {
        color: #2d3a4a;
      }
      .biodata-list {
        margin: 0 0 1.5rem 1.5rem;
        padding: 0;
        color: #2d3a4a;
      }
      .biodata-subtable th, .biodata-subtable td {
        font-size: 1rem;
        padding: 0.5rem 0.7rem;
      }
      .biodata-subtable th {
        width: 160px;
      }
      .biodata-section {
        margin-bottom: 2rem;
      }
      .biodata-table input, .biodata-table textarea, .biodata-table select {
        width: 100%;
        padding: 0.4rem 0.7rem;
        border: 1px solid #c3d0e6;
        border-radius: 5px;
        font-size: 1rem;
        background: #f7faff;
        color: #2d3a4a;
        resize: vertical;
      }
      .biodata-table textarea {
        min-height: 2.2rem;
      }
      .biodata-list input {
        width: 80%;
        margin-bottom: 0.5rem;
      }
      .biodata-list .remove-skill {
        background: #e17055;
        color: #fff;
        border: none;
        border-radius: 4px;
        margin-left: 0.5rem;
        cursor: pointer;
        font-size: 0.95rem;
        padding: 0.1rem 0.6rem;
      }
      .biodata-list .remove-skill:hover {
        background: #d63031;
      }
      .add-btn {
        background: #5b8bd8;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.4rem 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        transition: background 0.2s;
      }
      .add-btn:hover {
        background: #3a5e9a;
      }
      .save-btn {
        background: #0984e3;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 0.7rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        margin: 2rem auto 0 auto;
        display: block;
        transition: background 0.2s;
      }
      .save-btn:hover {
        background: #3a5e9a;
      }
      @media print {
        body {
          background: #fff;
        }
        .biodata-container {
          box-shadow: none;
          border-radius: 0;
        }
        .save-btn, .add-btn, .remove-skill {
          display: none !important;
        }
      }
      .danger-zone {
        margin-top: 2.5rem;
        padding: 2.7rem 2.2rem 2.2rem 2.2rem;
        border: 2px solid #e74c3c;
        background: #fff6f6;
        border-radius: 16px;
        box-shadow: 0 2px 16px rgba(231,76,60,0.09);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        font-size: 1.08rem;
      }
      .danger-zone .dz-title {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        font-weight: 700;
        color: #e74c3c;
        font-size: 1.18rem;
        margin-bottom: 0.3rem;
      }
      .danger-zone .dz-desc {
        color: #b03a2e;
        font-size: 0.98rem;
        margin-bottom: 1.2rem;
      }
      .danger-zone label {
        color: #c0392b;
        font-weight: 600;
        margin-bottom: 0.2rem;
        display: block;
      }
      .danger-zone input[type="email"],
      .danger-zone input[type="password"] {
        width: 100%;
        max-width: 100%;
        padding: 0.5rem 0.7rem;
        border: 1.5px solid #e0b4b4;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        background: #fff;
        transition: border 0.2s;
      }
      .danger-zone input[type="email"]:focus,
      .danger-zone input[type="password"]:focus {
        border: 1.5px solid #e74c3c;
        outline: none;
      }
      .danger-zone button {
        background: #e74c3c;
        color: #fff;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 0.2rem;
        margin-bottom: 0.2rem;
        transition: background 0.2s;
      }
      .danger-zone button:hover {
        background: #c0392b;
      }
      .danger-zone .delete-btn {
        background: #fff;
        color: #e74c3c;
        border: 2px solid #e74c3c;
        font-weight: 700;
        margin-top: 0.7rem;
      }
      .danger-zone .delete-btn:hover {
        background: #e74c3c;
        color: #fff;
      }
      .danger-zone .dz-status {
        font-size: 0.97rem;
        margin-top: 0.2rem;
        min-height: 1.2em;
      }
      @media (max-width: 600px) {
        .danger-zone { padding: 1.2rem 0.5rem; }
      }
    </style>
</head>
<body>
  <form class="biodata-container">
    <button type="button" id="backBtn" class="back-btn">‚Üê Back</button>
    <div style="display:flex;align-items:center;gap:1.5rem;margin-bottom:1.5rem;">
      <div style="position:relative;width:120px;height:120px;">
        <img id="profilePhotoPreview" src="" alt="Profile Photo" style="width:120px;height:120px;border-radius:50%;object-fit:cover;background:#f7faff;border:2px solid #c3d0e6;box-shadow:0 2px 8px rgba(44,62,80,0.08);position:absolute;top:0;left:0;">
        <span id="profilePhotoPlaceholder" style="position:absolute;top:0;left:0;width:120px;height:120px;display:flex;align-items:center;justify-content:center;font-size:2.7rem;color:#b2bec3;background:#f7faff;border-radius:50%;">üë§</span>
      </div>
      <div>
        <label for="profilePhotoInput" style="font-weight:600;color:#3a5e9a;">Upload Profile Photo</label><br>
        <input type="file" id="profilePhotoInput" accept="image/*" style="margin-top:0.5rem;">
        <button type="button" id="uploadProfilePhotoBtn" style="margin-left:0.5rem;">Upload</button>
        <button type="button" id="deleteProfilePhotoBtn" style="margin-left:0.5rem;background:#fff;color:#e74c3c;border:1.5px solid #e74c3c;">Delete Photo</button>
        <div id="profilePhotoStatus" style="font-size:0.98rem;color:#5c6b82;margin-top:0.3rem;"></div>
      </div>
    </div>
    <div class="biodata-title">EDIT WORK BIODATA</div>

    <div class="biodata-section">
      <div class="biodata-section-title">1. Personal Information</div>
      <table class="biodata-table">
        <tr><th>Full Name</th><td><input type="text" name="fullName" required></td></tr>
        <tr><th>Date of Birth</th><td><input type="date" name="dob" required></td></tr>
        <tr><th>Age</th><td><input type="number" name="age" min="0" readonly></td></tr>
        <tr><th>Gender</th><td><select name="gender"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></td></tr>
        <tr><th>Civil Status</th><td><select name="civilStatus"><option value="">Select</option><option>Single</option><option>Married</option><option>Divorced</option><option>Widowed</option></select></td></tr>
        <tr><th>Nationality</th><td><input type="text" name="nationality"></td></tr>
        <tr><th>Religion</th><td><input type="text" name="religion"></td></tr>
        <tr><th>Complete Address</th><td><textarea name="address"></textarea></td></tr>
        <tr><th>Contact Number</th><td><input type="text" name="contact"></td></tr>
        <tr><th>Email Address</th><td><input type="email" name="email" required></td></tr>
      </table>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">2. Career Objective</div>
      <textarea name="objective" style="width:100%;min-height:3.5rem;"></textarea>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">3. Educational Background</div>
      <table class="biodata-table biodata-subtable">
        <tr><th>Level</th><th>School Name</th><th>Year Graduated</th><th>Honors/Awards</th></tr>
        <tr><td>Elementary</td><td><input type="text" name="elemSchool"></td><td><input type="text" name="elemYear"></td><td><input type="text" name="elemHonors"></td></tr>
        <tr><td>Secondary</td><td><input type="text" name="secSchool"></td><td><input type="text" name="secYear"></td><td><input type="text" name="secHonors"></td></tr>
        <tr><td>Tertiary</td><td><input type="text" name="terSchool"></td><td><input type="text" name="terYear"></td><td><input type="text" name="terHonors"></td></tr>
      </table>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">4. Skills and Qualifications</div>
      <ul class="biodata-list" id="skillsList">
        <li><input type="text" name="skills[]"><button type="button" class="remove-skill">Remove</button></li>
      </ul>
      <button type="button" class="add-btn" id="addSkillBtn">Add Skill</button>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">5. Work Experience</div>
      <table class="biodata-table biodata-subtable" id="workExpTable">
        <tr><th>Position</th><th>Company Name</th><th>Inclusive Dates</th><th>Responsibilities/Highlights</th><th></th></tr>
        <tr>
          <td><input type="text" name="position[]"></td>
          <td><input type="text" name="company[]"></td>
          <td><input type="text" name="dates[]"></td>
          <td><input type="text" name="highlights[]"></td>
          <td><button type="button" class="remove-skill">Remove</button></td>
        </tr>
      </table>
      <button type="button" class="add-btn" id="addWorkBtn">Add Work Experience</button>
    </div>

    <div class="biodata-section">
      <div class="biodata-section-title">6. Strengths</div>
      <ul class="biodata-list" id="strengthsList">
        <li><input type="text" name="strengths[]"><button type="button" class="remove-skill">Remove</button></li>
      </ul>
      <button type="button" class="add-btn" id="addStrengthBtn">Add Strength</button>
      <div class="biodata-section-title" style="margin-top:2rem;">7. Weaknesses</div>
      <ul class="biodata-list" id="weaknessesList">
        <li><input type="text" name="weaknesses[]"><button type="button" class="remove-skill">Remove</button></li>
      </ul>
      <button type="button" class="add-btn" id="addWeaknessBtn">Add Weakness</button>
    </div>

    <button type="submit" class="save-btn">Save</button>
  </form>
  <div class="danger-zone">
    <div class="dz-title"><span style="font-size:1.5rem;">&#9888;&#65039;</span> Danger Zone</div>
    <div class="dz-desc">Sensitive actions below. Please proceed with caution.</div>
    <div style="margin-bottom:1.2rem;">
      <label for="dangerEmail">Change Email</label>
      <input type="email" id="dangerEmail">
      <button type="button" id="changeEmailBtn">Change Email</button>
      <div id="dangerEmailStatus" class="dz-status"></div>
    </div>
    <div style="margin-bottom:1.2rem;">
      <label for="dangerOldPassword">Change Password</label>
      <input type="password" id="dangerOldPassword" placeholder="Old password">
      <input type="password" id="dangerNewPassword" placeholder="New password">
      <input type="password" id="dangerRepeatPassword" placeholder="Repeat new password">
      <button type="button" id="changePasswordBtn">Change Password</button>
      <div id="dangerPasswordStatus" class="dz-status"></div>
    </div>
    <div>
      <button type="button" id="deleteAccountBtn" class="delete-btn">Delete Account</button>
      <div id="dangerDeleteStatus" class="dz-status"></div>
    </div>
  </div>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, updateEmail, updatePassword, deleteUser, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBSw3t0Picp9CrK0CsB_FXeSC7wHuZQbMw",
        authDomain: "carlix-7fbcb.firebaseapp.com",
        projectId: "carlix-7fbcb",
        storageBucket: "carlix-7fbcb.firebasestorage.app",
        messagingSenderId: "679556059179",
        appId: "1:679556059179:web:1893b4b1063e87dd789a6e",
        measurementId: "G-TMKR8YLFR4"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const form = document.querySelector('.biodata-container');
      const loadingMsg = document.createElement('div');
      loadingMsg.textContent = 'Loading...';
      loadingMsg.style.textAlign = 'center';
      loadingMsg.style.margin = '1.5rem 0';
      form.insertBefore(loadingMsg, form.firstChild);

      let currentUid = null;
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUid = user.uid;
          // Fetch and populate user data
          const userDoc = await getDoc(doc(db, 'users', currentUid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            // Set all form fields
            form.fullName.value = data.fullName || ((data.firstName && data.lastName) ? `${data.firstName} ${data.lastName}` : '');
            form.dob.value = data.dateOfBirth || data.birthdate || data.dob || '';
            form.age.value = data.age || '';
            form.gender.value = data.gender || '';
            form.civilStatus.value = data.civilStatus || '';
            form.nationality.value = data.nationality || '';
            form.religion.value = data.religion || '';
            form.address.value = data.address || '';
            form.contact.value = data.contactNumber || '';
            form.email.value = data.email || user.email || '';
            form.objective.value = data.objective || '';
            form.elemSchool.value = (data.education?.elementary?.school) || data.elemSchool || '';
            form.elemYear.value = (data.education?.elementary?.year) || data.elemYear || '';
            form.elemHonors.value = (data.education?.elementary?.honors) || data.elemHonors || '';
            form.secSchool.value = (data.education?.secondary?.school) || data.secSchool || '';
            form.secYear.value = (data.education?.secondary?.year) || data.secYear || '';
            form.secHonors.value = (data.education?.secondary?.honors) || data.secHonors || '';
            form.terSchool.value = (data.education?.tertiary?.school) || data.terSchool || '';
            form.terYear.value = (data.education?.tertiary?.year) || data.terYear || '';
            form.terHonors.value = (data.education?.tertiary?.honors) || data.terHonors || '';
            // Skills
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';
            (Array.isArray(data.skills) ? data.skills : ['']).forEach(skill => {
              const li = document.createElement('li');
              li.innerHTML = `<input type="text" name="skills[]" value="${skill}"><button type="button" class="remove-skill">Remove</button>`;
              skillsList.appendChild(li);
            });
            // Strengths
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = '';
            (Array.isArray(data.strengths) ? data.strengths : ['']).forEach(strength => {
              const li = document.createElement('li');
              li.innerHTML = `<input type="text" name="strengths[]" value="${strength}"><button type="button" class="remove-skill">Remove</button>`;
              strengthsList.appendChild(li);
            });
            // Weaknesses
            const weaknessesList = document.getElementById('weaknessesList');
            weaknessesList.innerHTML = '';
            (Array.isArray(data.weaknesses) ? data.weaknesses : ['']).forEach(weakness => {
              const li = document.createElement('li');
              li.innerHTML = `<input type="text" name="weaknesses[]" value="${weakness}"><button type="button" class="remove-skill">Remove</button>`;
              weaknessesList.appendChild(li);
            });
            // Work Experience
            const workExpTable = document.getElementById('workExpTable');
            workExpTable.querySelectorAll('tr:not(:first-child)').forEach(tr => tr.remove());
            (data.workExperience || [{position:'',company:'',dates:'',highlights:''}]).forEach(exp => {
              const row = document.createElement('tr');
              row.innerHTML = `<td><input type="text" name="position[]" value="${exp.position||''}"></td><td><input type="text" name="company[]" value="${exp.company||''}"></td><td><input type="text" name="dates[]" value="${exp.dates||''}"></td><td><input type="text" name="highlights[]" value="${exp.highlights||''}"></td><td><button type="button" class="remove-skill">Remove</button></td>`;
              workExpTable.appendChild(row);
            });
            // References
            // The old references table and add button are removed, so this block is no longer needed.
            // Profile Photo
            if (data.profilePicUrl) {
              profilePhotoPreview.src = data.profilePicUrl;
              profilePhotoPreview.style.display = 'block';
              profilePhotoPlaceholder.style.display = 'none';
            }
          }
        } else {
          window.location.href = 'index.html';
        }
      });

      form.onsubmit = async function(e) {
        e.preventDefault();
        if (!currentUid) return;
        // Gather all data
        const education = {
          elementary: { school: form.elemSchool.value, year: form.elemYear.value, honors: form.elemHonors.value },
          secondary: { school: form.secSchool.value, year: form.secYear.value, honors: form.secHonors.value },
          tertiary: { school: form.terSchool.value, year: form.terYear.value, honors: form.terHonors.value }
        };
        const skills = Array.from(form.querySelectorAll('input[name="skills[]"]')).map(i => i.value).filter(Boolean);
        const strengths = Array.from(form.querySelectorAll('input[name="strengths[]"]')).map(i => i.value).filter(Boolean);
        const weaknesses = Array.from(form.querySelectorAll('input[name="weaknesses[]"]')).map(i => i.value).filter(Boolean);
        const workExperience = Array.from(document.querySelectorAll('#workExpTable tr:not(:first-child)')).map(tr => {
          const tds = tr.querySelectorAll('td');
          return {
            position: tds[0].querySelector('input').value,
            company: tds[1].querySelector('input').value,
            dates: tds[2].querySelector('input').value,
            highlights: tds[3].querySelector('input').value
          };
        }).filter(exp => exp.position || exp.company || exp.dates || exp.highlights);
        // References are removed, so this block is no longer needed.
        // Save to Firestore
        try {
          await setDoc(doc(db, 'users', currentUid), {
            fullName: form.fullName.value,
            dateOfBirth: form.dob.value,
            age: form.age.value,
            gender: form.gender.value,
            civilStatus: form.civilStatus.value,
            nationality: form.nationality.value,
            religion: form.religion.value,
            address: form.address.value,
            contactNumber: form.contact.value,
            email: form.email.value,
            objective: form.objective.value,
            education,
            skills,
            strengths,
            weaknesses,
            workExperience
          }, { merge: true });
          alert('Profile updated!');
          window.location.href = 'dashboard.html';
        } catch (err) {
          alert('Failed to save: ' + err.message);
        }
      };

      // Danger Zone logic
      const dangerEmail = document.getElementById('dangerEmail');
      const changeEmailBtn = document.getElementById('changeEmailBtn');
      const dangerEmailStatus = document.getElementById('dangerEmailStatus');
      const dangerOldPassword = document.getElementById('dangerOldPassword');
      const dangerNewPassword = document.getElementById('dangerNewPassword');
      const dangerRepeatPassword = document.getElementById('dangerRepeatPassword');
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const dangerPasswordStatus = document.getElementById('dangerPasswordStatus');
      const deleteAccountBtn = document.getElementById('deleteAccountBtn');
      const dangerDeleteStatus = document.getElementById('dangerDeleteStatus');

      // Change Email
      changeEmailBtn.addEventListener('click', async () => {
        dangerEmailStatus.textContent = '';
        if (!dangerEmail.value || !currentUid) {
          dangerEmailStatus.textContent = 'Please enter a valid email.';
          dangerEmailStatus.style.color = 'red';
          return;
        }
        try {
          const user = auth.currentUser;
          await updateEmail(user, dangerEmail.value);
          await setDoc(doc(db, 'users', currentUid), { email: dangerEmail.value }, { merge: true });
          dangerEmailStatus.textContent = 'Email updated successfully!';
          dangerEmailStatus.style.color = 'green';
        } catch (err) {
          if (err.code === 'auth/requires-recent-login') {
            dangerEmailStatus.textContent = 'Please re-authenticate to change your email.';
          } else {
            dangerEmailStatus.textContent = err.message || 'Failed to update email.';
          }
          dangerEmailStatus.style.color = 'red';
        }
      });

      // Change Password
      changePasswordBtn.addEventListener('click', async () => {
        dangerPasswordStatus.textContent = '';
        if (!dangerOldPassword.value || !dangerNewPassword.value || !dangerRepeatPassword.value || !currentUid) {
          dangerPasswordStatus.textContent = 'Please fill in all password fields.';
          dangerPasswordStatus.style.color = 'red';
          return;
        }
        if (dangerNewPassword.value !== dangerRepeatPassword.value) {
          dangerPasswordStatus.textContent = 'New passwords do not match.';
          dangerPasswordStatus.style.color = 'red';
          return;
        }
        try {
          const user = auth.currentUser;
          // Re-authenticate with old password
          const credential = EmailAuthProvider.credential(user.email, dangerOldPassword.value);
          await reauthenticateWithCredential(user, credential);
          await updatePassword(user, dangerNewPassword.value);
          dangerPasswordStatus.textContent = 'Password updated successfully!';
          dangerPasswordStatus.style.color = 'green';
          dangerOldPassword.value = '';
          dangerNewPassword.value = '';
          dangerRepeatPassword.value = '';
        } catch (err) {
          if (err.code === 'auth/wrong-password') {
            dangerPasswordStatus.textContent = 'Old password is incorrect.';
          } else if (err.code === 'auth/requires-recent-login') {
            dangerPasswordStatus.textContent = 'Please re-authenticate to change your password.';
          } else {
            dangerPasswordStatus.textContent = err.message || 'Failed to update password.';
          }
          dangerPasswordStatus.style.color = 'red';
        }
      });

      // Delete Account
      deleteAccountBtn.addEventListener('click', async () => {
        dangerDeleteStatus.textContent = '';
        if (!currentUid) return;
        if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
        try {
          const user = auth.currentUser;
          await deleteUser(user);
          await setDoc(doc(db, 'users', currentUid), {}, { merge: false }); // Optionally delete user data
          dangerDeleteStatus.textContent = 'Account deleted. Redirecting...';
          dangerDeleteStatus.style.color = 'green';
          setTimeout(() => { window.location.href = 'index.html'; }, 2000);
        } catch (err) {
          if (err.code === 'auth/requires-recent-login') {
            dangerDeleteStatus.textContent = 'Please re-authenticate to delete your account.';
          } else {
            dangerDeleteStatus.textContent = err.message || 'Failed to delete account.';
          }
          dangerDeleteStatus.style.color = 'red';
        }
      });

      // --- Restore Back Button and Profile Photo Upload Functionality ---
      document.addEventListener('DOMContentLoaded', () => {
        // Back button
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            window.history.length > 1 ? window.history.back() : window.location.href = 'dashboard.html';
          });
        }
        // Profile photo upload
        const profilePhotoInput = document.getElementById('profilePhotoInput');
        const uploadProfilePhotoBtn = document.getElementById('uploadProfilePhotoBtn');
        const profilePhotoPreview = document.getElementById('profilePhotoPreview');
        const profilePhotoPlaceholder = document.getElementById('profilePhotoPlaceholder');
        const profilePhotoStatus = document.getElementById('profilePhotoStatus');
        const deleteProfilePhotoBtn = document.getElementById('deleteProfilePhotoBtn');
        let uploadedProfilePicUrl = '';
        // Cloudinary config and helper
        const CLOUDINARY_CLOUD_NAME = 'dzvojulwb';
        const CLOUDINARY_UNSIGNED_PRESET = 'charlix';
        async function uploadProfilePic(file) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', CLOUDINARY_UNSIGNED_PRESET);
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if (data.secure_url) {
            return data.secure_url;
          } else {
            throw new Error('Profile picture upload failed.');
          }
        }
        if (uploadProfilePhotoBtn) {
          uploadProfilePhotoBtn.addEventListener('click', async () => {
            profilePhotoStatus.textContent = '';
            if (!profilePhotoInput.files || !profilePhotoInput.files[0]) {
              profilePhotoStatus.textContent = 'Please select a photo first.';
              profilePhotoStatus.style.color = 'red';
              return;
            }
            if (!currentUid) {
              profilePhotoStatus.textContent = 'User not loaded yet.';
              profilePhotoStatus.style.color = 'red';
              return;
            }
            const file = profilePhotoInput.files[0];
            profilePhotoStatus.textContent = 'Uploading...';
            profilePhotoStatus.style.color = '#5c6b82';
            try {
              const url = await uploadProfilePic(file);
              uploadedProfilePicUrl = url;
              // Save to Firestore
              await setDoc(doc(db, 'users', currentUid), { profilePicUrl: url }, { merge: true });
              // Always show the uploaded image as the profile photo
              profilePhotoPreview.src = url;
              profilePhotoPreview.style.display = 'block';
              profilePhotoPlaceholder.style.display = 'none';
              profilePhotoStatus.textContent = 'Upload successful!';
              profilePhotoStatus.style.color = 'green';
            } catch (err) {
              profilePhotoStatus.textContent = err.message || 'Upload failed.';
              profilePhotoStatus.style.color = 'red';
            }
          });
        }
        // On page load, if a profilePicUrl exists, show it in the preview
        (async () => {
          if (currentUid) {
            const userDoc = await getDoc(doc(db, 'users', currentUid));
            if (userDoc.exists()) {
              const data = userDoc.data();
              if (data.profilePicUrl) {
                profilePhotoPreview.src = data.profilePicUrl;
                profilePhotoPreview.style.display = 'block';
                profilePhotoPlaceholder.style.display = 'none';
              }
            }
          }
        })();
        // Profile photo preview logic
        if (profilePhotoInput) {
          profilePhotoInput.addEventListener('change', function() {
            if (profilePhotoInput.files && profilePhotoInput.files[0]) {
              const reader = new FileReader();
              reader.onload = function(e) {
                profilePhotoPreview.src = e.target.result;
                profilePhotoPreview.style.display = 'block';
                profilePhotoPlaceholder.style.display = 'none';
                profilePhotoStatus.textContent = '';
              };
              reader.readAsDataURL(profilePhotoInput.files[0]);
            } else {
              profilePhotoPreview.src = '';
              profilePhotoPreview.style.display = 'none';
              profilePhotoPlaceholder.style.display = 'flex';
              profilePhotoStatus.textContent = '';
            }
          });
        }
        // Delete profile photo logic
        if (deleteProfilePhotoBtn) {
          deleteProfilePhotoBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to remove your profile photo?')) return;
            profilePhotoPreview.src = '';
            profilePhotoPreview.style.display = 'none';
            profilePhotoPlaceholder.style.display = 'flex';
            profilePhotoInput.value = '';
            profilePhotoStatus.textContent = 'Photo removed.';
            profilePhotoStatus.style.color = '#e74c3c';
            if (currentUid) {
              await setDoc(doc(db, 'users', currentUid), { profilePicUrl: '' }, { merge: true });
            }
          });
        }
      });
    </script>
  </body>
</html> 